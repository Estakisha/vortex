<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vortex Magazine</title>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- Flipbook -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>

    <style>
        body { background: #1a1a1a; color: white; font-family: sans-serif; margin: 0; }
        #bookshelf { padding: 50px; display: flex; gap: 40px; justify-content: center; }
        
        .book-item { cursor: pointer; text-align: center; width: 200px; }
        
        .cover-box {
            width: 100%; height: 280px;
            background: #333; border-radius: 5px;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden; border: 1px solid #444;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
        }
        
        canvas { width: 100%; height: 100%; object-fit: cover; }
        
        .status-msg { padding: 20px; color: #ffeb3b; font-size: 14px; text-align: center; }

        /* Viewer */
        #viewer {
            display: none; position: fixed; top: 0; left: 0;
            width: 100%; height: 100%; background: rgba(0,0,0,0.95);
            z-index: 999; flex-direction: column;
            align-items: center; justify-content: center;
        }
        #book-stage { width: 500px; height: 750px; }
        .page { background: white; overflow: hidden; }
        #close-btn { position: absolute; top: 20px; right: 20px; padding: 10px 20px; cursor: pointer; }
    </style>
</head>
<body>

    <h1 style="text-align: center;">VORTEX LIBRARY</h1>
    
    <!-- Status Log for Debugging -->
    <div id="debug-log" class="status-msg">Initializing...</div>

    <div id="bookshelf">
        <!-- Book 1 -->
        <div class="book-item" onclick="openMagazine('Vortex01.pdf')">
            <div class="cover-box" id="cover-container">
                <div class="spinner">Loading Cover...</div>
            </div>
            <div style="margin-top:10px">Vortex 01</div>
        </div>
    </div>

    <div id="viewer">
        <button id="close-btn" onclick="document.getElementById('viewer').style.display='none'">CLOSE X</button>
        <div id="book-stage"></div>
    </div>

    <script>
        // ============================================
        // 1. PATH CONFIGURATION (RELATIVE)
        // ============================================
        // This looks for the 'pdf' folder in the same place as index.html
        const FOLDER = './pdf/'; 

        const log = document.getElementById('debug-log');

        // ============================================
        // 2. DIAGNOSTIC LOADER
        // ============================================
        async function checkAndLoadCover() {
            const filename = 'Vortex01.pdf';
            const url = FOLDER + filename;
            const container = document.getElementById('cover-container');

            log.innerHTML = `Checking path: <b>${new URL(url, window.location.href).href}</b>`;

            try {
                // STEP 1: Verify file exists and is actually a PDF
                const response = await fetch(url, { method: 'HEAD' });
                
                if (response.status === 404) {
                    throw new Error("404 Not Found (Check file name casing!)");
                }
                
                const type = response.headers.get('content-type');
                if (type && type.includes('text/html')) {
                    throw new Error("Server returned HTML instead of PDF (Path is wrong)");
                }

                log.innerHTML = "Path verified! Downloading PDF...";

                // STEP 2: Load PDF
                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);
                
                const canvas = document.createElement('canvas');
                const viewport = page.getViewport({ scale: 1 });
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                await page.render({
                    canvasContext: canvas.getContext('2d'),
                    viewport: viewport
                }).promise;

                container.innerHTML = '';
                container.appendChild(canvas);
                log.innerHTML = "Library Loaded Successfully.";
                log.style.color = "#4caf50";

            } catch (err) {
                console.error(err);
                container.innerHTML = "‚ùå ERROR";
                container.style.color = "red";
                log.innerHTML = `ERROR: ${err.message}`;
                log.style.color = "red";
            }
        }

        // ============================================
        // 3. READER FUNCTION
        // ============================================
        let bookInstance = null;

        async function openMagazine(filename) {
            const url = FOLDER + filename;
            const viewer = document.getElementById('viewer');
            const stage = document.getElementById('book-stage');

            viewer.style.display = 'flex';
            stage.innerHTML = "Loading Pages...";
            
            if (bookInstance) { bookInstance.destroy(); bookInstance = null; }

            try {
                const pdf = await pdfjsLib.getDocument(url).promise;
                stage.innerHTML = ""; // Clear text

                // Loop Pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const div = document.createElement('div');
                    div.className = 'page';
                    
                    const canvas = document.createElement('canvas');
                    const viewport = page.getViewport({ scale: 1.5 });
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    await page.render({
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    }).promise;
                    
                    div.appendChild(canvas);
                    stage.appendChild(div);
                }

                // Init Flip
                bookInstance = new St.PageFlip(stage, {
                    width: 500, height: 750,
                    showCover: true
                });
                bookInstance.loadFromHTML(document.querySelectorAll('.page'));

            } catch (err) {
                alert("Could not load book: " + err.message);
                viewer.style.display = 'none';
            }
        }

        // Run on start
        checkAndLoadCover();

    </script>
</body>
</html>
