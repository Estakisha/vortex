<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vortex</title>
    
    <!-- PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    
    <!-- StPageFlip -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>

    <style>
        body {
            margin: 0;
            font-family: 'Segoe UI', sans-serif;
            background-color: #2c2c2c; /* Darker background for contrast */
            color: white;
            overflow-x: hidden;
        }

        h1 { margin-top: 30px; font-weight: 300; letter-spacing: 2px; }

        /* Bookshelf Styles */
        #bookshelf {
            padding: 40px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); /* Bigger covers */
            gap: 40px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .book-item {
            background: transparent;
            perspective: 1000px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .cover-wrapper {
            width: 100%;
            aspect-ratio: 1 / 1.4; /* Standard magazine ratio */
            background: #444;
            border-radius: 4px;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            overflow: hidden;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .cover-wrapper:hover {
            transform: translateY(-10px) rotateY(-5deg);
            box-shadow: 10px 10px 20px rgba(0,0,0,0.6);
        }

        /* The canvas inside the shelf item */
        .cover-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .loading-spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            color: #aaa;
        }

        .book-title {
            margin-top: 15px;
            font-size: 14px;
            color: #ddd;
            text-align: center;
            max-width: 100%;
        }

        /* Viewer Styles */
        #viewer {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(10, 10, 10, 0.95);
            z-index: 100;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .flip-book {
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }

        .page {
            background-color: white;
            overflow: hidden;
        }
        
        .page canvas {
            width: 100%;
            height: 100%;
        }

        /* Controls */
        #controls {
            position: absolute;
            bottom: 30px;
            z-index: 102;
            display: flex;
            gap: 20px;
        }

        .btn {
            padding: 10px 25px;
            background: #444;
            color: white;
            border: 1px solid #666;
            border-radius: 30px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn:hover { background: #666; }

        #close-btn {
            position: absolute;
            top: 30px;
            right: 30px;
            background: transparent;
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-weight: bold;
            cursor: pointer;
            z-index: 103;
        }

        #loading-overlay {
            color: white;
            font-size: 24px;
            display: none;
            position: absolute;
            z-index: 200;
        }
    </style>
</head>
<body>

    <h1 style="text-align: center;">MAGAZINE RACK</h1>
    
    <div id="bookshelf">
        <!-- JS inserts books here -->
        <p style="text-align: center; width: 100%;">Scanning library...</p>
    </div>

    <!-- Viewer -->
    <div id="viewer">
        <button id="close-btn" onclick="closeViewer()">✕</button>
        <div id="loading-overlay">Rendering Magazine...</div>
        <div id="book" class="flip-book"></div>
        <div id="controls">
            <button class="btn" onclick="book.flipPrev()">Previous</button>
            <button class="btn" onclick="book.flipNext()">Next</button>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            // The folder name in your repo where PDFs are. 
            // Case Sensitive! If folder is "PDF", write "PDF"
            folder: 'pdf', 
            
            // MANUAL LIST (Recommended for GitHub Pages to avoid API errors)
            
            files: [
                'Vortex01.pdf' 
                // Add more filenames here...
            ]
        };

        // Initialize PDF.js worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

        let book = null; 
        
        // ---------------------------------------------------------
        // 1. Setup Bookshelf with Lazy Loading Covers
        // ---------------------------------------------------------
        function initBookshelf() {
            const shelf = document.getElementById('bookshelf');
            shelf.innerHTML = '';

            // Setup Intersection Observer for Lazy Loading
            const observer = new IntersectionObserver((entries, obs) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const target = entry.target;
                        const filename = target.dataset.filename;
                        const canvas = target.querySelector('canvas');
                        const spinner = target.querySelector('.loading-spinner');
                        
                        // Load cover logic
                        loadCover(filename, canvas, spinner);
                        
                        // Stop observing this element once loaded
                        obs.unobserve(target);
                    }
                });
            }, { rootMargin: "100px" });

            // Create placeholder elements
            CONFIG.files.forEach(file => {
                const col = document.createElement('div');
                col.className = 'book-item';
                col.onclick = () => openPDF(file);

                col.innerHTML = `
                    <div class="cover-wrapper" data-filename="${file}">
                        <div class="loading-spinner">Loading Cover...</div>
                        <canvas class="cover-canvas"></canvas>
                    </div>
                    <div class="book-title">${file.replace('.pdf', '')}</div>
                `;

                shelf.appendChild(col);
                
                // Tell observer to watch the wrapper
                const wrapper = col.querySelector('.cover-wrapper');
                observer.observe(wrapper);
            });
        }

        // ---------------------------------------------------------
        // 2. Generate Cover (Page 1) for Shelf
        // ---------------------------------------------------------
        async function loadCover(filename, canvas, spinner) {
            const url = `${CONFIG.folder}/${filename}`;
            
            try {
                // Fetch only first page logic
                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);
                
                const viewport = page.getViewport({ scale: 1.0 }); // Thumbnail scale
                const context = canvas.getContext('2d');
                
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                await page.render({
                    canvasContext: context,
                    viewport: viewport
                }).promise;

                // Hide text, show canvas
                spinner.style.display = 'none';
                
                // Cleanup to save memory
                pdf.destroy();
            } catch (err) {
                console.error(`Error loading cover for ${filename}:`, err);
                spinner.innerHTML = "❌ Failed";
                spinner.style.color = "red";
            }
        }

        // ---------------------------------------------------------
        // 3. Open Viewer (Full Magazine)
        // ---------------------------------------------------------
        async function openPDF(filename) {
            const url = `${CONFIG.folder}/${filename}`;
            const viewer = document.getElementById('viewer');
            const bookEl = document.getElementById('book');
            const loader = document.getElementById('loading-overlay');

            viewer.style.display = 'flex';
            loader.style.display = 'block';
            bookEl.style.display = 'none';
            bookEl.innerHTML = ''; // Clean old pages

            try {
                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                
                // Render all pages to canvas
                // Note: For very large PDFs (50+ pages), we would need a more complex
                // on-demand renderer. For magazines (<30 pages), this loop is fine.
                for (let num = 1; num <= pdf.numPages; num++) {
                    const page = await pdf.getPage(num);
                    
                    const div = document.createElement('div');
                    div.className = 'page';
                    
                    const canvas = document.createElement('canvas');
                    div.appendChild(canvas);
                    bookEl.appendChild(div);

                    // High quality for reading
                    const viewport = page.getViewport({ scale: 1.5 });
                    canvas.height = viewport.height;
                    canvas.width = viewport.width;

                    const ctx = canvas.getContext('2d');
                    await page.render({
                        canvasContext: ctx,
                        viewport: viewport
                    }).promise;
                }

                initFlipBook();

            } catch (err) {
                alert("Could not load PDF. Check file name match!");
                console.error(err);
                closeViewer();
            }
        }

        function initFlipBook() {
            document.getElementById('loading-overlay').style.display = 'none';
            const bookEl = document.getElementById('book');
            bookEl.style.display = 'block';

            const isMobile = window.innerWidth < 768;

            // Destroy old instance if exists
            if (book) book.destroy();

            book = new St.PageFlip(bookEl, {
                width: isMobile ? window.innerWidth * 0.9 : 550,
                height: isMobile ? window.innerHeight * 0.7 : 750,
                size: isMobile ? 'fixed' : 'stretch',
                minWidth: 300,
                maxWidth: 1000,
                minHeight: 400,
                maxHeight: 1200,
                showCover: true,
                maxShadowOpacity: 0.5
            });

            book.loadFromHTML(document.querySelectorAll('.page'));
        }

        function closeViewer() {
            document.getElementById('viewer').style.display = 'none';
        }

        // Start
        initBookshelf();

    </script>
</body>
</html>

