<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vortex Archive</title>
    
    <!-- 1. PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- 2. Flipbook Library -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>

    <style>
        :root {
            --bg-color: #121212;
            --card-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #ffffff;
            --shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;
            overflow-x: hidden;
        }

        /* HEADER */
        header {
            text-align: center;
            padding: 40px 20px;
            letter-spacing: 4px;
            text-transform: uppercase;
            border-bottom: 1px solid #333;
        }

        h1 { margin: 0; font-weight: 300; font-size: 2rem; }

        /* SHELF GRID */
        #shelf {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 40px;
            padding: 40px 8%;
            max-width: 1400px;
            margin: 0 auto;
        }

        /* CARD DESIGN */
        .book-card {
            background: transparent;
            perspective: 1000px;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .book-card:hover { transform: translateY(-10px); }

        .cover-wrapper {
            position: relative;
            width: 100%;
            aspect-ratio: 1 / 1.414; /* Standard A4 Ratio */
            background: var(--card-bg);
            border-radius: 4px;
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        /* The canvas inside the grid */
        .cover-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        .book-title {
            margin-top: 15px;
            font-size: 0.9rem;
            text-align: center;
            color: #aaa;
            letter-spacing: 1px;
        }

        /* SPINNER (Pure CSS) */
        .spinner {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 30px; height: 30px;
            border: 3px solid rgba(255,255,255,0.1);
            border-radius: 50%;
            border-top-color: var(--accent-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin { 100% { transform: translate(-50%, -50%) rotate(360deg); } }

        /* VIEWER OVERLAY */
        #viewer {
            display: none;
            position: fixed;
            top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(0, 0, 0, 0.95); /* Darker backdrop */
            z-index: 2000;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        #viewer.active { opacity: 1; }

        /* FLIPBOOK CONTAINER */
        #book-stage {
            /* Shadow behind the open book */
            box-shadow: 0 20px 50px rgba(0,0,0,0.8);
            transition: transform 0.3s;
        }

        .page { background-color: white; overflow: hidden; }
        .page canvas { width: 100%; height: 100%; object-fit: contain; }

        /* CONTROLS */
        .control-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255,255,255,0.1);
            color: white;
            border: none;
            width: 50px; height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            transition: background 0.2s;
            display: flex; align-items: center; justify-content: center;
        }
        .control-btn:hover { background: rgba(255,255,255,0.3); }
        #prev-btn { left: 20px; }
        #next-btn { right: 20px; }

        #close-btn {
            position: absolute;
            top: 30px; right: 30px;
            background: transparent;
            border: 2px solid white;
            color: white;
            width: 40px; height: 40px;
            border-radius: 50%;
            font-size: 18px;
            cursor: pointer;
            z-index: 2001;
            transition: transform 0.2s;
        }
        #close-btn:hover { transform: rotate(90deg); }

        #loader-overlay {
            position: absolute;
            color: white;
            font-size: 1.2rem;
            letter-spacing: 2px;
            display: none;
        }

        /* Responsive */
        @media (max-width: 768px) {
            #shelf { padding: 20px; gap: 20px; grid-template-columns: repeat(2, 1fr); }
            header { padding: 20px; font-size: 0.8rem; }
            .control-btn { display: none; /* Hide arrows on mobile, rely on swipe */ }
        }
    </style>
</head>
<body>

    <header>
        <h1>VORTEX</h1>
    </header>

    <div id="shelf">
        <!-- Javascript will inject books here -->
    </div>

    <!-- Viewer -->
    <div id="viewer">
        <button id="close-btn" onclick="closeViewer()">✕</button>
        
        <!-- Navigation Arrows -->
        <button id="prev-btn" class="control-btn" onclick="bookInstance.flipPrev()">❮</button>
        <button id="next-btn" class="control-btn" onclick="bookInstance.flipNext()">❯</button>

        <div id="loader-overlay">
            <div class="spinner"></div>
            <div style="margin-top: 40px">OPENING...</div>
        </div>

        <div id="book-stage"></div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const CONFIG = {
            // Folder Path (keep the ./pdf/ structure)
            folder: './pdf/', 
            
            // File List (Exact filenames, Case Sensitive!)
            files: [
                'Vortex01.pdf',
                // 'Issue2.pdf', 
            ]
        };

        // Global Variable for the Flipbook
        let bookInstance = null;

        // 1. Initialize Shelf
        function initShelf() {
            const shelf = document.getElementById('shelf');
            
            CONFIG.files.forEach(filename => {
                const card = document.createElement('div');
                card.className = 'book-card';
                card.innerHTML = `
                    <div class="cover-wrapper" id="wrap-${filename}">
                        <div class="spinner"></div>
                        <canvas class="cover-canvas"></canvas>
                    </div>
                    <div class="book-title">${filename.replace('.pdf', '')}</div>
                `;
                
                card.onclick = () => openReader(filename);
                shelf.appendChild(card);

                // Load the cover image
                generateCover(filename, card.querySelector('canvas'), card.querySelector('.spinner'));
            });
        }

        // 2. Generate High-Quality Cover
        async function generateCover(filename, canvas, spinner) {
            const url = CONFIG.folder + filename;
            try {
                const pdf = await pdfjsLib.getDocument(url).promise;
                const page = await pdf.getPage(1);
                
                // Get viewport at 1.5 scale for sharp thumbnail
                const viewport = page.getViewport({ scale: 1.5 });
                
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                await page.render({
                    canvasContext: canvas.getContext('2d'),
                    viewport: viewport
                }).promise;

                // Reveal
                spinner.style.display = 'none';
                canvas.style.opacity = '1';

            } catch (err) {
                // Silent fail UI update
                spinner.style.borderTopColor = 'red';
                console.warn("Cover load failed:", filename);
            }
        }

        // 3. Open the Viewer
        async function openReader(filename) {
            const viewer = document.getElementById('viewer');
            const stage = document.getElementById('book-stage');
            const loader = document.getElementById('loader-overlay');
            
            // Animation In
            viewer.style.display = 'flex';
            requestAnimationFrame(() => viewer.classList.add('active'));
            
            loader.style.display = 'block';
            stage.innerHTML = ''; // Clear old pages
            stage.style.opacity = '0'; // Hide until ready

            if (bookInstance) { bookInstance.destroy(); bookInstance = null; }

            try {
                const url = CONFIG.folder + filename;
                const pdf = await pdfjsLib.getDocument(url).promise;

                // Determine Book Size based on window height
                // Leave 100px padding for UI
                const isMobile = window.innerWidth < 768;
                const availableHeight = window.innerHeight * 0.85;
                const baseWidth = isMobile ? window.innerWidth * 0.9 : (availableHeight * 0.7); 
                const baseHeight = availableHeight;

                // Render Pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    const div = document.createElement('div');
                    div.className = 'page';
                    
                    // Set explicit page size for Flipbook Engine
                    // On desktop, width is per-page (so book is 2x width)
                    // On mobile, width is single page view
                    const pgWidth = isMobile ? baseWidth : (baseWidth / 2);
                    
                    div.style.width = pgWidth + 'px';
                    div.style.height = baseHeight + 'px';

                    const canvas = document.createElement('canvas');
                    
                    // Render at high resolution (2.0) for zooming clarity
                    // But draw it into the smaller canvas container
                    const viewport = page.getViewport({ scale: 2 });
                    
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    await page.render({
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    }).promise;
                    
                    div.appendChild(canvas);
                    stage.appendChild(div);
                }

                loader.style.display = 'none';
                stage.style.opacity = '1';

                // Start Flipbook
                bookInstance = new St.PageFlip(stage, {
                    width: isMobile ? baseWidth : (baseWidth / 2),
                    height: baseHeight,
                    size: 'fixed',
                    minWidth: 200,
                    maxWidth: 1000,
                    minHeight: 300,
                    maxHeight: 1200,
                    showCover: true,
                    maxShadowOpacity: 0.5,
                    autoSize: true,
                    mobileScrollSupport: true // Enables swipe on mobile
                });

                bookInstance.loadFromHTML(document.querySelectorAll('.page'));

            } catch (err) {
                console.error(err);
                closeViewer(); // Close on error silently
            }
        }

        function closeViewer() {
            const viewer = document.getElementById('viewer');
            viewer.classList.remove('active');
            setTimeout(() => {
                viewer.style.display = 'none';
            }, 300); // Wait for fade out
        }

        // Start
        initShelf();

    </script>
</body>
</html>
