<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vortex</title>
    
    <!-- 1. LOAD LIBRARIES (Matching Versions) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        // Set worker explicitly
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- Flipbook Library -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>

    <style>
        body { margin: 0; font-family: sans-serif; background: #333; color: white; }

        /* --- SHELF --- */
        #bookshelf {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 30px;
            padding: 50px;
        }

        .book-item {
            width: 200px;
            cursor: pointer;
            text-align: center;
        }

        .cover-canvas {
            width: 100%;
            height: auto; /* Maintains aspect ratio */
            box-shadow: 0 10px 20px rgba(0,0,0,0.5);
            background: white;
            transition: transform 0.2s;
            border-radius: 4px;
        }

        .cover-canvas:hover { transform: scale(1.05); }

        /* --- VIEWER (Overlay) --- */
        #viewer {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: rgba(0,0,0,0.95);
            z-index: 999;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        /* The Container for the FlipBook */
        #book-container {
            /* These dimensions are critical for initialization */
            width: 500px; 
            height: 700px;
            max-width: 90vw;
            max-height: 80vh;
        }

        /* Individual Pages */
        .page {
            background-color: white;
            padding: 0;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.1);
            overflow: hidden; /* Hide scrollbars */
        }

        /* Canvas inside page must fit exactly */
        .page canvas {
            width: 100% !important;
            height: 100% !important;
            object-fit: contain;
        }

        #close-btn {
            position: absolute; top: 20px; right: 20px;
            padding: 10px 20px; background: red; color: white;
            border: none; cursor: pointer; font-size: 16px;
            z-index: 1000;
        }

        #loading-msg { font-size: 20px; margin-bottom: 20px; color: #aaa; }
    </style>
</head>
<body>

    <h1 style="text-align:center;">Vortex</h1>
    
    <div id="bookshelf">
        <!-- Javascript will put books here -->
        <p>Loading Library...</p>
    </div>

    <!-- Viewer Overlay -->
    <div id="viewer">
        <button id="close-btn" onclick="closeViewer()">CLOSE X</button>
        <div id="loading-msg">Opening Magazine...</div>
        
        <!-- The flipbook mounts here -->
        <div id="book-container"></div>
    </div>

    <script>
        // ===========================================
        // CONFIG: LIST YOUR FILES HERE
        // ===========================================
        const myBooks = [
            'Vortex01.pdf' 
        ];
        
        // This handles the path automatically. 
        // It assumes "pdf" folder is in the same place as "index.html"
        const FOLDER_PATH = './pdf/'; 

        let pageFlip = null;

        // 1. STARTUP: Generate the Shelf
        async function initShelf() {
            const shelf = document.getElementById('bookshelf');
            shelf.innerHTML = ''; // Clear loading text

            if(myBooks.length === 0) {
                shelf.innerHTML = "No books configured in JS.";
                return;
            }

            for (const filename of myBooks) {
                // Create HTML structure
                const item = document.createElement('div');
                item.className = 'book-item';
                
                // Create Canvas for Cover
                const canvas = document.createElement('canvas');
                canvas.className = 'cover-canvas';
                item.appendChild(canvas);

                // Title
                const title = document.createElement('div');
                title.innerText = filename;
                title.style.marginTop = "10px";
                item.appendChild(title);

                // Click event
                item.onclick = () => openMagazine(filename);
                shelf.appendChild(item);

                // Render the cover (Page 1) immediately
                renderCover(filename, canvas);
            }
        }

        // 2. HELPER: Render just page 1 for the shelf
        async function renderCover(filename, canvas) {
            try {
                const url = FOLDER_PATH + filename;
                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                const page = await pdf.getPage(1);
                
                const viewport = page.getViewport({ scale: 0.5 }); // Small scale for thumb
                canvas.height = viewport.height;
                canvas.width = viewport.width;

                const context = canvas.getContext('2d');
                await page.render({ canvasContext: context, viewport: viewport }).promise;
            } catch (error) {
                console.error("Error loading cover for " + filename, error);
                // Draw a red X if failed
                const ctx = canvas.getContext('2d');
                canvas.width = 150; canvas.height = 200;
                ctx.fillStyle = "#333"; ctx.fillRect(0,0,150,200);
                ctx.fillStyle = "red"; ctx.font = "20px Arial";
                ctx.fillText("PDF Error", 30, 100);
            }
        }

        // 3. MAIN: Open the Full Magazine
        async function openMagazine(filename) {
            const viewer = document.getElementById('viewer');
            const container = document.getElementById('book-container');
            const msg = document.getElementById('loading-msg');

            // Show Viewer, reset container
            viewer.style.display = 'flex';
            msg.style.display = 'block';
            container.innerHTML = ''; 
            
            // Clean up old instance
            if (pageFlip) {
                pageFlip.destroy();
                pageFlip = null;
            }

            try {
                const url = FOLDER_PATH + filename;
                console.log("Fetching PDF from:", url);
                
                const loadingTask = pdfjsLib.getDocument(url);
                const pdf = await loadingTask.promise;
                console.log("PDF Loaded, Pages:", pdf.numPages);

                // Create div elements for every page
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i);
                    
                    // 1. Create Page Container
                    const pageDiv = document.createElement('div');
                    pageDiv.className = 'page';
                    
                    // 2. Create Canvas
                    const canvas = document.createElement('canvas');
                    pageDiv.appendChild(canvas);
                    container.appendChild(pageDiv);

                    // 3. Render High Quality PDF to Canvas
                    // We use scale 1.5 or 2.0 for sharp text
                    const viewport = page.getViewport({ scale: 1.5 });
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    const ctx = canvas.getContext('2d');
                    await page.render({ canvasContext: ctx, viewport: viewport }).promise;
                    
                    // Update Loading Text
                    msg.innerText = `Rendering Page ${i} of ${pdf.numPages}...`;
                }

                // 4. Initialize FlipBook AFTER DOM is ready
                msg.style.display = 'none';
                
                // Determine screen size for book size
                const isMobile = window.innerWidth < 600;

                pageFlip = new St.PageFlip(container, {
                    width: isMobile ? 300 : 500, // Base width
                    height: isMobile ? 420 : 700, // Base height
                    size: isMobile ? 'fixed' : 'stretch',
                    minWidth: 300,
                    maxWidth: 1000,
                    minHeight: 400,
                    maxHeight: 1200,
                    showCover: true,
                    maxShadowOpacity: 0.5
                });

                pageFlip.loadFromHTML(document.querySelectorAll('.page'));

            } catch (error) {
                console.error(error);
                alert("Error: " + error.message + "\nCheck console (F12) for details.");
                closeViewer();
            }
        }

        function closeViewer() {
            document.getElementById('viewer').style.display = 'none';
        }

        // Start
        initShelf();

    </script>
</body>
</html>
