<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vortex Magazine</title>
    
    <!-- 1. PDF.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    </script>
    
    <!-- 2. Flipbook Library -->
    <script src="https://cdn.jsdelivr.net/npm/page-flip@2.0.7/dist/js/page-flip.browser.min.js"></script>

    <style>
        body { margin: 0; background: #1a1a1a; color: white; font-family: sans-serif; }
        
        /* --- SHELF --- */
        #shelf { display: flex; flex-wrap: wrap; justify-content: center; gap: 30px; padding: 50px; }
        
        .book-item { width: 180px; text-align: center; cursor: pointer; }
        
        .cover-box {
            width: 100%; height: 260px; background: #333;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            margin-bottom: 10px; border-radius: 4px; overflow: hidden;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s;
        }
        .cover-box:hover { transform: translateY(-5px); }
        .cover-box canvas { width: 100%; height: 100%; object-fit: cover; }

        /* --- VIEWER OVERLAY --- */
        #viewer {
            display: none; /* Hidden by default */
            position: fixed; top: 0; left: 0;
            width: 100vw; height: 100vh;
            background: rgba(10, 10, 10, 0.98);
            z-index: 999;
            flex-direction: column;
            align-items: center; justify-content: center;
        }

        /* The container for the book */
        .book-stage {
            /* Keep this relative so the canvas can position inside */
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        /* CRITICAL: Pages must have dimensions for the library to work */
        .page {
            background-color: white;
            overflow: hidden;
            /* Default dimensions, JS will override for mobile */
            width: 400px; 
            height: 600px; 
        }

        .page canvas {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        #close-btn {
            position: absolute; top: 20px; right: 20px;
            background: none; border: 2px solid white;
            color: white; padding: 10px 20px; cursor: pointer;
            z-index: 1000; font-weight: bold;
        }

        #loading-txt { font-size: 18px; color: #aaa; margin-bottom: 20px; }
    </style>
</head>
<body>

    <h1 style="text-align: center; margin-top:30px;">VORTEX LIBRARY</h1>

    <!-- 1. The Shelf -->
    <div id="shelf"></div>

    <!-- 2. The Viewer -->
    <div id="viewer">
        <button id="close-btn" onclick="closeViewer()">CLOSE X</button>
        <div id="loading-txt">Loading...</div>
        <!-- The Flipbook Container -->
        <div id="book" class="book-stage"></div>
    </div>

    <script>
        // ===================================
        // CONFIG
        // ===================================
        const CONFIG = {
            folder: './pdf/', 
            files: ['Vortex01.pdf'] // Exact filename
        };

        let bookInstance = null;

        // 1. Init Shelf
        function initShelf() {
            const shelf = document.getElementById('shelf');
            CONFIG.files.forEach(file => {
                const div = document.createElement('div');
                div.className = 'book-item';
                div.innerHTML = `
                    <div class="cover-box" id="cover-${file}">
                        <span>Loading...</span>
                    </div>
                    <div>${file.replace('.pdf', '')}</div>
                `;
                div.onclick = () => openBook(file);
                shelf.appendChild(div);
                loadCover(file);
            });
        }

        // 2. Load Cover
        async function loadCover(filename) {
            const url = CONFIG.folder + filename;
            try {
                const pdf = await pdfjsLib.getDocument(url).promise;
                const page = await pdf.getPage(1);
                
                const viewport = page.getViewport({ scale: 1 });
                const canvas = document.createElement('canvas');
                canvas.width = viewport.width;
                canvas.height = viewport.height;
                
                await page.render({
                    canvasContext: canvas.getContext('2d'),
                    viewport: viewport
                }).promise;

                const box = document.getElementById(`cover-${filename}`);
                box.innerHTML = '';
                box.appendChild(canvas);
            } catch (e) {
                console.error(e);
            }
        }

        // 3. OPEN BOOK (The Fix)
        async function openBook(filename) {
            const viewer = document.getElementById('viewer');
            const stage = document.getElementById('book');
            const txt = document.getElementById('loading-txt');
            
            // Show Viewer immediately
            viewer.style.display = 'flex';
            stage.innerHTML = ''; // Clear old pages
            txt.style.display = 'block';
            txt.innerText = "Downloading PDF...";

            // Determine Size based on screen
            const isMobile = window.innerWidth < 768;
            const width = isMobile ? 300 : 450;
            const height = isMobile ? 420 : 640;

            if (bookInstance) { bookInstance.destroy(); bookInstance = null; }

            try {
                const url = CONFIG.folder + filename;
                const pdf = await pdfjsLib.getDocument(url).promise;

                // Loop Pages
                for (let i = 1; i <= pdf.numPages; i++) {
                    txt.innerText = `Rendering Page ${i} / ${pdf.numPages}`;
                    const page = await pdf.getPage(i);
                    
                    // Create Page Div
                    const div = document.createElement('div');
                    div.className = 'page';
                    
                    // FORCE CSS DIMENSIONS (Critical for Flipbook)
                    div.style.width = width + 'px';
                    div.style.height = height + 'px';
                    
                    // Render Canvas
                    const canvas = document.createElement('canvas');
                    // Scale match the div size
                    const viewport = page.getViewport({ scale: width / page.getViewport({scale:1}).width });
                    
                    canvas.width = viewport.width;
                    canvas.height = viewport.height;
                    
                    await page.render({
                        canvasContext: canvas.getContext('2d'),
                        viewport: viewport
                    }).promise;

                    div.appendChild(canvas);
                    stage.appendChild(div);
                }

                txt.style.display = 'none';

                // Init Flipbook with explicit dimensions
                bookInstance = new St.PageFlip(stage, {
                    width: width,
                    height: height,
                    size: 'fixed', // Forces the size we set above
                    showCover: true,
                    maxShadowOpacity: 0.5
                });

                bookInstance.loadFromHTML(document.querySelectorAll('.page'));

            } catch (err) {
                alert("Error: " + err.message);
                console.error(err);
                closeViewer();
            }
        }

        function closeViewer() {
            document.getElementById('viewer').style.display = 'none';
        }

        initShelf();
    </script>
</body>
</html>
